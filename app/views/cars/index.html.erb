<% content_for :title, "#{t('cars.index.title')} - #{t('app.brand')}" %>

<!-- Filters Section -->
<section class="filters-section">
  <div class="container mb-2">
  <div class="mobile-top-bar">
      <!-- Mobile Language Switcher (hidden on desktop) -->
      <div class="mobile-quick-call">
        <span class="mobile-call-text"><%#= t('cars.index.call_to_book') %></span>
        <a href="tel:+38971297645" class="quick-call-link" aria-label="<%= t('contact.info.phone.title') %>">üìû</a>
      </div>
      <div class="mobile-language-switcher">
        <% I18n.available_locales.each do |loc| %>
          <% if loc == I18n.locale %>
            <span class="lang current"><%= t("app.language.#{loc}") %></span>
          <% else %>
            <%= link_to t("app.language.#{loc}"), url_for(params.permit!.to_h.merge(locale: loc)), class: 'lang' %>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="filters-header">
      <h2 class="filters-title"><%= t('cars.index.find_perfect') %></h2>
      <p class="filters-subtitle"><%= t('cars.index.subtitle1') %></p>
      <p class="filters-subtitle"><%= t('cars.index.subtitle2') %></p>
    </div>

  <%= form_with url: cars_path, method: :get, data: { turbo_frame: "cars-list" }, class: "filters-form", html: { data: { controller: "filters" } } do |form| %>
      <div class="filters-container">
        <!-- Date Availability Filters -->
        <div class="date-availability-section">
          <h4 class="filter-section-title"><%= t('cars.index.check_availability') %></h4>
          <div class="date-filters">
            <div class="filter-group">
              <label class="filter-label"><%= t('cars.index.pickup_date') %></label>
              <%= form.date_field :start_date, 
                  value: params[:start_date], 
                  min: Date.current,
                  class: "filter-input" %>
            </div>
            
            <div class="filter-group">
              <label class="filter-label"><%= t('cars.index.dropoff_date') %></label>
              <%= form.date_field :end_date, 
                  value: params[:end_date], 
                  min: Date.current + 1.day,
                  class: "filter-input" %>
            </div>
          </div>
          
          <% if @date_filtered %>
            <div class="date-filter-status">
              <span class="status-icon">‚úÖ</span>
              <span><%= t('cars.index.showing_for_dates', from: @filter_start_date.strftime('%b %d'), to: @filter_end_date.strftime('%b %d, %Y')) %></span>
              <%= link_to t('cars.index.clear_dates'), cars_path(brand: params[:brand], year_from: params[:year_from], year_to: params[:year_to], max_price: params[:max_price]), class: "clear-dates-btn" %>
            </div>
          <% end %>
        </div>

        <!-- Collapsible Other Filters -->
        <div class="other-filters-toggle-wrapper">
          <button type="button" class="btn btn-secondary btn-filter btn-filter-toggle"
                  data-filters-target="button"
                  data-action="filters#toggle"
                  data-label="<%= t('cars.index.more_filters') %>"
                  aria-expanded="false" aria-controls="additional-filters-panel">
            <span data-filters-target="toggleLabel">‚ûï <%= t('cars.index.more_filters') %></span>
          </button>
        </div>

        <div id="additional-filters-panel" class="other-filters-section" data-filters-target="panel" hidden>
          <h4 class="filter-section-title"><%= t('cars.index.more_filters') %></h4>
          <div class="other-filters">
            <div class="filter-group">
              <label class="filter-label"><%= t('cars.index.brand') %></label>
              <%= form.text_field :brand, value: params[:brand], placeholder: t('cars.index.brand_placeholder'), class: "filter-input" %>
            </div>
            <div class="filter-group">
              <label class="filter-label"><%= t('cars.index.year_from') %></label>
              <%= form.number_field :year_from, value: params[:year_from], placeholder: "2020", class: "filter-input" %>
            </div>
            <div class="filter-group">
              <label class="filter-label"><%= t('cars.index.year_to') %></label>
              <%= form.number_field :year_to, value: params[:year_to], placeholder: "2025", class: "filter-input" %>
            </div>
            <div class="filter-group">
              <label class="filter-label"><%= t('cars.index.max_price') %></label>
              <%= form.number_field :max_price, value: params[:max_price], placeholder: "500", step: 0.01, class: "filter-input" %>
            </div>
          </div>
        </div>
        
        <div class="filters-actions">
          <%= form.submit t('cars.index.filter_submit'), class: "btn btn-primary btn-filter" %>
          <%= link_to t('cars.index.reset_all'), cars_path, class: "btn btn-secondary btn-filter" %>
        </div>
      </div>
    <% end %>
  </div>
</section>

<!-- Cars Content -->
<section class="cars-content" data-controller="cars">
  <div class="container">
    <%= turbo_frame_tag "cars-list" do %>
      <% if @cars.any? %>
        <div class="cars-grid" data-cars-target="grid">
          <% @cars.each do |car| %>
            <div class="car-card" data-cars-target="card">
              <div class="car-image-wrapper">
                <img src="<%= car.image_url %>" alt="Rent a car Skopje - <%= car.full_name %>" class="car-image">
                <div class="car-status-badge <%= car.available? ? 'available' : 'unavailable' %>">
                  <%= car.available? ? t('cars.show.available') : t('cars.show.unavailable') %>
                </div>
                <div class="car-year-badge"><%= car.year %></div>
              </div>
              
              <div class="car-details">
                <div class="car-brand"><%= car.brand %></div>
                <h3 class="car-name"><%= car.model %></h3>
                
                <div class="car-specs">
                  <div class="car-spec">
                    <span class="car-spec-icon">üìÖ</span>
                    <span><%= car.year %></span>
                  </div>
                  <div class="car-spec">
                    <span class="car-spec-icon">‚ö°</span>
                    <span>
                      <% if @date_filtered %>
                        <%= t('cars.index.available_for_dates') %>
                      <% elsif car.available? %>
                        <%= t('cars.show.available') %>
                      <% else %>
                        <%= t('cars.show.currently_unavailable') %>
                      <% end %>
                    </span>
                  </div>
                  <div class="car-spec">
                    <span class="car-spec-icon">üõ°Ô∏è</span>
                    <span><%= t('cars.index.insured') %></span>
                  </div>
                  <div class="car-spec">
                    <span class="car-spec-icon">üîß</span>
                    <span><%= t('cars.index.maintained') %></span>
                  </div>
                </div>
                
                <p class="car-description-preview"><%= car.description %></p>
                
                <div class="car-actions">
                  <div class="car-price-display">
                    <div class="car-price">‚Ç¨<%= car.price_per_day %></div>
                    <div class="car-price-unit"><%= t('cars.index.price_per_day') %></div>
                  </div>

                  <div class="car-action-buttons">
                    <%= link_to t('cars.index.view_details'), car_path(car), class: "btn btn-secondary car-view-btn", data: { turbo_frame: "_top" } %>
                    
                    <% if @date_filtered %>
                      <%= link_to t('cars.index.send_inquiry'), new_car_booking_inquiry_path(car, start_date: @filter_start_date, end_date: @filter_end_date), 
                          class: "btn btn-primary car-book-btn", data: { turbo_frame: "_top" } %>
                    <% else %>
                      <%= link_to t('cars.index.send_inquiry'), new_car_booking_inquiry_path(car), 
                          class: "btn btn-primary car-book-btn", data: { turbo_frame: "_top" } %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state">
          <div class="empty-state-icon">üöó</div>
          <h3><%= t('cars.index.empty_title') %></h3>
          <p><%= t('cars.index.empty_body') %></p>
          <%= link_to t('cars.index.reset_filters'), cars_path, class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>
  </div>
</section>
