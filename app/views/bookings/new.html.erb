<% content_for :title, "#{t('bookings.new.title', default: 'Book Car')}#{" - #{@car.full_name}" if @car} - #{t('app.brand')}" %>

<section class="booking-header">
  <div class="container">
    <% if @car %>
      <div class="back-nav">
        <%= link_to car_path(@car), class: "back-link" do %>
          <span class="back-icon">‚Üê</span>
          <%= t('booking_inquiries.new.back_to_car') %>
        <% end %>
      </div>
    <% end %>
    
    <h1><%= t('bookings.new.heading', default: 'Book Your Car') %></h1>
    <p><%= t('bookings.new.intro', default: 'Complete your booking details below') %></p>
  </div>
</section>

<section class="booking-content">
  <div class="container">
    <div class="booking-layout">
      <!-- Car Summary (if car is selected) -->
      <% if @car %>
        <div class="car-summary-card">
          <div class="car-summary-image">
            <img src="<%= @car.image_url %>" alt="Rent a car Skopje - <%= @car.full_name %>" class="summary-car-image">
          </div>
          <div class="car-summary-details">
            <h3><%= @car.full_name %></h3>
            <div class="summary-price">
              <span class="price-amount">‚Ç¨<%= @car.price_per_day %></span>
              <span class="price-unit"><%= t('booking_inquiries.new.price_per_day') %></span>
            </div>
            <div class="car-features">
              <div class="feature"><%= t('booking_inquiries.new.car_fully_insured') %></div>
              <div class="feature"><%= t('booking_inquiries.new.car_well_maintained') %></div>
              <div class="feature"><%= t('booking_inquiries.new.car_available') %></div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Booking Form -->
      <div class="booking-form-card">
        <% if flash[:alert] %>
          <div class="error-messages">
            <h4>–ì—Ä–µ—à–∫–∞</h4>
            <p><%= flash[:alert] %></p>
          </div>
        <% end %>

        <% total_errors = 0 %>
        <% total_errors += @booking.errors.count if @booking %>
        <% total_errors += @customer.errors.count if @customer %>

        <% if total_errors > 0 %>
          <div class="error-messages">
            <h4><%= pluralize(total_errors, "–≥—Ä–µ—à–∫–∞") %> –≥–æ —Å–ø—Ä–µ—á–∏ –∑–∞—á—É–≤—É–≤–∞—ö–µ—Ç–æ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—ò–∞—Ç–∞:</h4>
            <ul>
              <% if @booking && @booking.errors.any? %>
                <% @booking.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              <% end %>
              <% if @customer && @customer.errors.any? %>
                <% @customer.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= form_with model: [@car, @booking], url: car_bookings_path(@car), class: "booking-form", data: { turbo: false } do |form| %>
          <div class="form-section">
            <h3><%= t('booking_inquiries.new.dates_heading') %></h3>
            <div class="date-inputs">
              <div class="date-group">
                <%= form.label :start_date, t('cars.index.pickup_date'), class: "form-label" %>
                <%= form.date_field :start_date, 
                    class: "form-input border", 
                    min: Date.current,
                    value: @booking.start_date,
                    required: true %>
              </div>
              <div class="date-group">
                <%= form.label :end_date, t('cars.index.dropoff_date'), class: "form-label" %>
                <%= form.date_field :end_date, 
                    class: "form-input border", 
                    min: Date.current + 1.day,
                    value: @booking.end_date,
                    required: true %>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3><%= t('booking_inquiries.new.location_heading') %></h3>
            <div class="input-group">
              <%= form.label :pickup_location, t('booking_inquiries.new.pickup_location'), class: "form-label" %>
              <%= form.select :pickup_location, 
                  [
                    [t('booking_inquiries.new.choose_location'), ""],
                    [t('booking_inquiries.new.location_option_center'), t('booking_inquiries.new.location_option_center')],
                    [t('booking_inquiries.new.location_option_airport'), t('booking_inquiries.new.location_option_airport')]
                  ],
                  { selected: @booking.pickup_location }, 
                  { class: "form-input border", required: true } %>
            </div>
          </div>

          <div class="form-section">
            <h3><%= t('booking_inquiries.new.your_info_heading') %></h3>
            <%= fields_for :customer, @customer do |customer_form| %>
              <div class="customer-inputs">
                <div class="name-row">
                  <div class="input-group">
                    <%= customer_form.label :first_name, t('booking_inquiries.new.first_name'), class: "form-label" %>
                    <%= customer_form.text_field :first_name, class: "form-input border", required: true %>
                  </div>
                  <div class="input-group">
                    <%= customer_form.label :last_name, t('booking_inquiries.new.last_name'), class: "form-label" %>
                    <%= customer_form.text_field :last_name, class: "form-input border", required: true %>
                  </div>
                </div>
                
                <div class="contact-row">
                  <div class="input-group">
                    <%= customer_form.label :email, t('booking_inquiries.new.email'), class: "form-label" %>
                    <%= customer_form.email_field :email, class: "form-input border", required: true %>
                  </div>
                  <div class="input-group">
                    <%= customer_form.label :phone, t('booking_inquiries.new.phone'), class: "form-label" %>
                    <%= customer_form.telephone_field :phone, class: "form-input border", required: true %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <div class="form-section" style="display: none;">
            <h3>Payment Method</h3>
            <div class="payment-methods">
              <div class="payment-option">
                <%= form.radio_button :payment_method, "pay_now", 
                    id: "payment_pay_now", 
                    class: "payment-radio", 
                    checked: @booking.payment_method == "pay_now" %>
                <%= form.label :payment_method, "Pay Now (Online)", 
                    for: "payment_pay_now", 
                    class: "payment-label" %>
                <p class="payment-description">Secure payment with Stripe. Complete your booking instantly.</p>
              </div>
              
              <div class="payment-option">
                <%= form.radio_button :payment_method, "pay_on_pickup", 
                    id: "payment_pay_on_pickup", 
                    class: "payment-radio", 
                    checked: @booking.payment_method == "pay_on_pickup" || @booking.payment_method.blank? %>
                <%= form.label :payment_method, "Pay on Pickup", 
                    for: "payment_pay_on_pickup", 
                    class: "payment-label" %>
                <p class="payment-description">Pay when you collect your vehicle. Cash or card accepted.</p>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3><%= t('bookings.new.payment_info_heading', default: 'Payment Information') %></h3>
            <div class="payment-info">
              <p class="payment-notice"><%= t('bookings.new.payment_notice', default: 'Payment will be made upon pickup of the vehicle. We accept both cash and card payments.') %></p>
            </div>
          </div>

          <div class="form-section">
            <h3><%= t('booking_inquiries.new.additional_info_heading') %></h3>
            <div class="input-group">
              <%= form.label :special_requests, t('booking_inquiries.new.message_optional'), class: "form-label" %>
              <%= form.text_area :special_requests, 
                  rows: 4, 
                  placeholder: t('booking_inquiries.new.message_placeholder'), 
                  class: "form-input border" %>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="form-actions">
            <%= form.submit t('bookings.new.book_now'), 
                class: "btn btn-primary btn-large" %>
            <p class="form-note"><%= t('bookings.new.note_response') %></p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</section>

<!-- Information Section -->
<section class="info-section" style="background: var(--bg-secondary); padding: var(--spacing-2xl) 0;">
  <div class="container">
    <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-xl);">
      <div class="info-card" style="text-align: center; padding: var(--spacing-xl); background: var(--bg-primary); border-radius: var(--radius-lg);">
        <div style="font-size: 2rem; margin-bottom: var(--spacing-md);">‚ö°</div>
            <h4><%= t('booking_inquiries.new.info_cards.fast_response_title') %></h4>
            <p><%= t('booking_inquiries.new.info_cards.fast_response_body') %></p>
      </div>
      <div class="info-card" style="text-align: center; padding: var(--spacing-xl); background: var(--bg-primary); border-radius: var(--radius-lg);">
        <div style="font-size: 2rem; margin-bottom: var(--spacing-md);">üí∞</div>
            <h4><%= t('booking_inquiries.new.info_cards.best_prices_title') %></h4>
            <p><%= t('booking_inquiries.new.info_cards.best_prices_body') %></p>
      </div>
      <div class="info-card" style="text-align: center; padding: var(--spacing-xl); background: var(--bg-primary); border-radius: var(--radius-lg);">
        <div style="font-size: 2rem; margin-bottom: var(--spacing-md);">üõ°Ô∏è</div>
            <h4><%= t('booking_inquiries.new.info_cards.safety_title') %></h4>
            <p><%= t('booking_inquiries.new.info_cards.safety_body') %></p>
      </div>
    </div>
  </div>
</section>
